# Docker
# Build a Docker image
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

trigger:
- master

resources:
- repo: self
 

variables:
  tag: '$(Build.BuildId)'
  solution: '**/*.sln'
  buildPlatform: 'Any CPU'
  buildConfiguration: 'Release'
  buildTime: $[format('0:yyyyMmddHHmmss', pipline.startTime)]

stages:

- stage: Build
  displayName: Build image
  jobs:
  - job: Build
    displayName: Build
    pool:
      vmImage: ubuntu-latest
    steps: 
 #   - task: UseDotNet@2
 #     displayName: 'Install .NET 3.1 SDK'
 #     inputs:
 #       version: '3.1.x'
 #   - task: DotNetCoreCLI@2
 #     inputs:
 #       command: 'restore'
 #       projects: '**/*.csproj'      
    - task: DotNetCoreCLI@2
      inputs:
        command: 'build'
        arguments: '--configuration $(buildConfiguration)'
        projects: '**/vincall.service.csproj'       
    - task: DotNetCoreCLI@2
      inputs:
        command: 'publish'
        publishWebProjects: true  
        arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)'
    - task: CopyFiles@2
      inputs:
        SourceFolder: '$(Build.ArtifactStagingDirectory)'
        Contents: '**'
        TargetFolder: './release' 
#    - task: Docker@2
#      displayName: Build an image
#      inputs:
#        command: build
#        dockerfile: '$(Build.SourcesDirectory)/Dockerfile'
#        tags: |
#          $(tag)
    - task: Docker@2
      inputs:
        containerRegistry: 'register'
        repository: 'x2/vincallservice/test-vincall:$(buildTime)-$(Build.BuildId)'
        command: 'buildAndPush'
        Dockerfile: '**/Dockerfile'